---
title: "legislator_template"
format: 
  html:
    echo: false
    message: false
    warning: false
    toc: true
    toc-location: right
    toc-depth: 2
    
params:
  people_id: 19548
---

```{r}
library(jsonlite)
library(readr)
library(dplyr)
library(purrr)
library(stringr)
library(tidyr)
library(gt)
```

```{r}
items_to_df <- function(list){
  map(list, as.data.frame) |>
    bind_rows()
}
```

```{r}
# Read legislator data
legislator <- read_json(here::here(str_glue("legiscan/files_ga91_json/people/{params$people_id}.json"))) |>
  pluck("person")

# Read related data
bills <- read_csv(here::here("legiscan/files_ga91/bills.csv"), show_col_types = FALSE)
sponsors <- read_csv(here::here("legiscan/files_ga91/sponsors.csv"), show_col_types = FALSE)
votes <- read_csv(here::here("legiscan/files_ga91/votes.csv"), show_col_types = FALSE)
rollcalls <- read_csv(here::here("legiscan/files_ga91/rollcalls.csv"), show_col_types = FALSE)

votes <- left_join(votes, rollcalls, by = join_by(roll_call_id)) |>
  left_join(bills |> select(bill_id, bill_number, title), by = join_by(bill_id))

# Filter to this legislator's activity
leg_sponsored_bills <- sponsors |>
  mutate(sponsor_num = n(), .by = bill_id) |>
  filter(people_id == params$people_id) |>
  left_join(bills, by = "bill_id") |>
  arrange(desc(status_date))

leg_votes <- votes |>
  filter(
    people_id == params$people_id,
    !str_detect(description, "Report$")
  )

# Load processed vote data for party alignment analysis
legislator_stats <- read_rds(here::here("data/legislator_voting_stats_91st_ga.rds"))
vote_records <- read_rds(here::here("data/vote_records_91st_ga.rds"))

leg_stats <- legislator_stats |> filter(people_id == params$people_id)
leg_vote_records <- vote_records |> filter(people_id == params$people_id)
```

# `r legislator$name` (`r legislator$party`-`r legislator$district`)

**Role:** `r legislator$role`  
**Party:** `r legislator$party`  
**District:** `r legislator$district`  
**State:** Iowa

---

## Profile

```{r}
profile_data <- data.frame(
  Field = c("Full Name", "Party", "Role", "District", "FTM EID", "VoteSmart ID", "Ballotpedia"),
  Value = c(
    legislator$name,
    legislator$party,
    legislator$role,
    legislator$district,
    as.character(legislator$ftm_eid),
    as.character(legislator$votesmart_id),
    legislator$ballotpedia
  )
)

gt(profile_data) |>
  cols_label(Field = "", Value = "")
```

**External Links:**

- [Ballotpedia Profile](https://ballotpedia.org/`r legislator$ballotpedia`){target="_blank"}
- [VoteSmart Profile](https://justfacts.votesmart.org/candidate/`r legislator$votesmart_id`){target="_blank"}

---

::: {.panel-tabset}

## Legislative Summary

```{r}
# Calculate summary statistics
total_sponsored <- nrow(leg_sponsored_bills)
total_votes <- nrow(leg_votes)

# Vote breakdown
if(nrow(leg_votes) > 0) {
  vote_summary <- leg_votes |>
    count(vote_desc) |>
    mutate(pct = n / sum(n) * 100)
} else {
  vote_summary <- data.frame(vote_desc = character(), n = integer(), pct = numeric())
}

# Sponsorship by role
if(nrow(leg_sponsored_bills) > 0) {
  sponsor_summary <- leg_sponsored_bills |>
    mutate(
      Role = case_when(
        position == 1 & sponsor_num == 1 ~ "Sole Sponsor",
        position == 1 ~ "Primary Sponsor",
        position >= 2 ~ "Co-Sponsor"
      )
    ) |>
    count(Role) |>
    select(Role, n)
} else {
  sponsor_summary <- data.frame(Role = character(), n = integer())
}
```

### Sponsorship Activity

**Total Bills Sponsored:** `r total_sponsored`

```{r}
if(nrow(sponsor_summary) > 0) {
  gt(sponsor_summary) |>
    cols_label(Role = "Sponsorship Type", n = "Count")
} else {
  cat("No sponsorship data available.\n")
}
```

### Voting Record

```{r}
if(nrow(vote_summary) > 0) {
  gt(vote_summary) |>
    cols_label(
      vote_desc = "Vote",
      n = "Count",
      pct = "Percentage"
    ) |>
    fmt_number(columns = pct, decimals = 1) |>
    cols_label(pct = "Percentage (%)")
} else {
  cat("No voting data available.\n")
}
```

### Party Alignment

```{r}
if(nrow(leg_stats) > 0 && leg_stats$total_votes > 0) {
  party_alignment <- data.frame(
    Metric = c(
      "Votes With Party",
      "Votes Against Party",
      "Party Alignment Rate",
      "Party Line Votes",
      "Bipartisan Votes",
      "Unanimous Votes",
      "Participation Rate"
    ),
    Value = c(
      as.character(leg_stats$votes_with_party),
      as.character(leg_stats$votes_against_party),
      sprintf("%.1f%%", leg_stats$with_party_pct * 100),
      as.character(leg_stats$party_line_votes),
      as.character(leg_stats$bipartisan_votes),
      as.character(leg_stats$unanimous_votes),
      sprintf("%.1f%%", leg_stats$participation_rate * 100)
    )
  )

  gt(party_alignment) |>
    cols_label(Metric = "", Value = "")
} else {
  cat("Insufficient voting data for party alignment analysis.\n")
}
```

## Sponsored Bills

```{r}
if(nrow(leg_sponsored_bills) > 0) {
  leg_sponsored_bills |>
    select(bill_number, title, status_desc, status_date, position, sponsor_num) |>
    mutate(
      Sponsor_Role = case_when(
        position == 1 & sponsor_num == 1 ~ "Sole Sponsor",
        position == 1 ~ "Primary Sponsor",
        position >= 2 ~ "Co-Sponsor"
      )
    ) |>
    select(-position) |>
    relocate(sponsor_num, .after = Sponsor_Role) |>
    gt() |>
    cols_label(
      bill_number = "Bill",
      title = "Title",
      status_desc = "Status",
      status_date = "Status Date",
      Sponsor_Role = "Role",
      sponsor_num = "# of Sponsors"
    ) |>
    tab_options(
      table.font.size = px(12)
    )
} else {
  cat("No sponsored bills found.\n")
}
```

## Voting Record

```{r}
if(nrow(leg_votes) > 0) {
  gt(leg_votes |> select(bill_number, title, date, description, vote_desc)) |>
    cols_label(
      bill_number = "File #",
      title = "Title",
      date = "Vote Date",
      description = "Vote Description",
      vote_desc = "Vote"
    )
} else {
  cat("No voting record found.\n")
}
```

## Vote Analysis

### Votes by Classification

```{r}
if(nrow(leg_vote_records) > 0) {
  outcome_breakdown <- leg_vote_records |>
    filter(vote_text %in% c("Yea", "Nay")) |>
    group_by(vote_outcome) |>
    summarize(
      count = n(),
      with_party = sum(vote_with_party == TRUE, na.rm = TRUE),
      against_party = sum(vote_with_party == FALSE, na.rm = TRUE),
      .groups = "drop"
    ) |>
    mutate(pct_of_total = count / sum(count) * 100) |>
    arrange(desc(count))

  gt(outcome_breakdown) |>
    cols_label(
      vote_outcome = "Vote Type",
      count = "Total",
      with_party = "With Party",
      against_party = "Against Party",
      pct_of_total = "% of Votes"
    ) |>
    fmt_number(columns = pct_of_total, decimals = 1)
} else {
  cat("Insufficient voting data for analysis.\n")
}
```

### Votes Against Party

```{r}
if(nrow(leg_vote_records) > 0) {
  against_party <- leg_vote_records |>
    filter(vote_with_party == FALSE) |>
    select(bill_number, vote_date, vote_desc, vote_text, party_position, vote_outcome) |>
    arrange(desc(vote_date))

  if(nrow(against_party) > 0) {
    gt(against_party) |>
      cols_label(
        bill_number = "Bill",
        vote_date = "Date",
        vote_desc = "Description",
        vote_text = "Vote",
        party_position = "Party Position",
        vote_outcome = "Classification"
      )
  } else {
    cat("This legislator has not voted against their party.\n")
  }
} else {
  cat("Insufficient voting data for analysis.\n")
}
```

:::

---

## Notes

This profile was generated from LegiScan data for the Iowa Legislature.  
Last updated: `r Sys.Date()`